<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GitDeploy Bridge</title>
    <!-- Tailwind CSS for rapid styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons for vector graphics -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .log-window::-webkit-scrollbar { width: 8px; }
        .log-window::-webkit-scrollbar-track { background: #1e293b; }
        .log-window::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: all 0.2s ease-out; }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 font-sans min-h-screen flex flex-col items-center p-4 md:p-8">

    <!-- MAIN CONTAINER -->
    <div class="w-full max-w-4xl bg-slate-800 rounded-2xl shadow-2xl border border-slate-700 overflow-hidden relative">
        
        <!-- HEADER -->
        <div class="bg-slate-950 p-6 flex items-center justify-between border-b border-slate-700">
            <!-- Clickable Title/Icon to go Home -->
            <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-opacity" onclick="AppController.goHome()">
                <div class="p-2 bg-blue-600 rounded-lg">
                    <i data-lucide="upload-cloud" class="text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">GitDeploy Bridge</h1>
                    <p class="text-slate-400 text-xs uppercase tracking-wider">GitHub.io Deployer</p>
                </div>
            </div>
            
            <!-- User Profile -->
            <div id="user-profile" class="hidden flex items-center gap-4">
                 <div class="flex flex-col items-end">
                    <div class="flex items-center gap-2">
                        <span id="user-login" class="text-sm font-bold text-white"></span>
                        <img id="user-avatar" src="" alt="" class="w-6 h-6 rounded-full border border-slate-600">
                    </div>
                    <span id="token-expiry" class="text-[10px] text-slate-500 font-mono mt-0.5"></span>
                 </div>
                 <button onclick="AppController.logout()" class="text-xs text-red-400 hover:text-red-300 underline" title="Clear Token">
                    Sign Out
                 </button>
            </div>
        </div>

        <!-- APP CONTENT -->
        <div class="p-6 md:p-8">
            
            <!-- Step Indicators -->
            <div class="flex items-center justify-center space-x-4 mb-8" id="step-indicator"></div>

            <!-- STEP 1: AUTHENTICATION -->
            <div id="step-1" class="space-y-6">
                <div class="bg-blue-900/20 border border-blue-800/50 p-4 rounded-lg flex gap-4">
                    <div class="p-2 bg-blue-900/50 rounded-md h-fit">
                        <i data-lucide="settings" class="text-blue-400 w-5 h-5"></i>
                    </div>
                    <div>
                        <h3 class="font-semibold text-blue-100 mb-1">Setup Required</h3>
                        <p class="text-sm text-blue-200/70">
                            You need a <strong>GitHub Personal Access Token (Classic)</strong> with <code>repo</code> and <code>workflow</code> permissions.
                            <br>
                            This runs entirely in your browser.
                        </p>
                        <a href="https://github.com/settings/tokens/new?scopes=repo,workflow" 
                           target="_blank" 
                           class="text-xs text-blue-400 hover:text-blue-300 underline mt-2 inline-flex items-center gap-1">
                            Generate Token <i data-lucide="external-link" class="w-3 h-3"></i>
                        </a>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1">GitHub Personal Access Token</label>
                    <input type="password" id="input-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                        class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white placeholder-slate-600 focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                </div>

                <div id="error-message" class="hidden p-3 bg-red-900/20 border border-red-800/50 rounded-lg flex items-center gap-2 text-red-300 text-sm">
                    <i data-lucide="alert-circle" class="w-4 h-4"></i>
                    <span id="error-text"></span>
                </div>

                <button onclick="AppController.verifyToken()" id="btn-verify"
                    class="w-full py-3 rounded-lg font-bold text-white flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-500 shadow-lg shadow-blue-900/20 transition-all">
                    <i data-lucide="github" class="w-5 h-5"></i> Connect to GitHub
                </button>
            </div>

            <!-- STEP 2: CONFIG & CODE -->
            <div id="step-2" class="hidden space-y-6">
                
                <!-- Project Type Toggle -->
                <div class="flex justify-center mb-6">
                    <div class="bg-slate-950 p-1 rounded-lg flex border border-slate-700">
                        <button onclick="UI.toggleMode('html')" id="mode-html" class="px-6 py-2 rounded-md text-sm font-bold transition-all bg-blue-600 text-white shadow-lg">
                            Static HTML
                        </button>
                        <button onclick="UI.toggleMode('react')" id="mode-react" class="px-6 py-2 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-all">
                            React App
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Repo Name -->
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1">Repository Name</label>
                        <div class="flex gap-2">
                            <input type="text" id="input-repo-name" value="my-web-app"
                                class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <button onclick="AppController.openRepoModal()" class="bg-slate-700 hover:bg-slate-600 border border-slate-600 text-white p-3 rounded-lg transition-colors" title="Browse Repositories">
                                <i data-lucide="folder-search" class="w-5 h-5"></i>
                            </button>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">
                            Tip: Name it <strong><span id="username-hint">username</span>.github.io</strong> for your main site.
                        </p>
                    </div>
                    <!-- Filename (HTML Mode Only) -->
                    <div id="filename-container">
                        <label class="block text-sm font-medium text-slate-400 mb-1">Target Filename</label>
                        <div class="relative">
                            <i data-lucide="file-code" class="absolute left-3 top-3.5 text-slate-500 w-4 h-4"></i>
                            <input type="text" id="input-filename" value="index.html"
                                class="w-full bg-slate-900 border border-slate-700 rounded-lg pl-10 pr-4 py-3 text-white focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <!-- Package JSON Info (React Mode Only) -->
                    <div id="react-info-container" class="hidden">
                        <label class="block text-sm font-medium text-slate-400 mb-1">Configuration</label>
                        <div class="bg-slate-900/50 border border-slate-700/50 rounded-lg p-3 flex items-center gap-3 text-xs text-slate-400">
                            <i data-lucide="package" class="w-8 h-8 text-orange-400"></i>
                            <div>
                                <p class="font-bold text-slate-200">Vite + React Scaffolding</p>
                                <p>Auto-generates <code>package.json</code>, <code>vite.config.js</code>, and GitHub Actions workflow.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Code Areas -->
                <div class="flex gap-6 h-96">
                    <!-- Main Code Input -->
                    <div class="flex-1 flex flex-col">
                        <label id="label-code-main" class="flex items-center justify-between text-sm font-medium text-slate-400 mb-2">
                            <span>HTML Code</span>
                            <span class="text-xs bg-slate-700 px-2 py-0.5 rounded text-slate-300">Paste Here</span>
                        </label>
                        <textarea id="input-code"
                            class="flex-1 w-full bg-slate-950 border border-slate-700 rounded-lg p-4 font-mono text-sm text-green-400 focus:ring-2 focus:ring-green-500/50 outline-none resize-none"
                            spellcheck="false"><!DOCTYPE html>
<html>
<body>
    <h1>Hello World</h1>
</body>
</html></textarea>
                    </div>

                    <!-- Package.json Input (React Mode Only) -->
                    <div id="package-json-container" class="hidden w-1/3 flex flex-col">
                        <label class="flex items-center justify-between text-sm font-medium text-slate-400 mb-2">
                            <span>package.json</span>
                            <span class="text-xs bg-slate-700 px-2 py-0.5 rounded text-slate-300">Dependencies</span>
                        </label>
                        <textarea id="input-package-json"
                            class="flex-1 w-full bg-slate-950 border border-slate-700 rounded-lg p-4 font-mono text-xs text-blue-300 focus:ring-2 focus:ring-blue-500/50 outline-none resize-none"
                            spellcheck="false">{
  "name": "react-app",
  "private": true,
  "version": "0.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "lucide-react": "^0.263.1"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.0.3",
    "vite": "^4.4.5"
  }
}</textarea>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button onclick="AppController.logout()"
                        class="px-6 py-3 rounded-lg font-medium text-slate-300 hover:bg-slate-700 transition-colors">
                        Logout
                    </button>
                    <button onclick="AppController.deploy()"
                        class="flex-1 bg-green-600 hover:bg-green-500 text-white rounded-lg py-3 font-bold shadow-lg shadow-green-900/20 flex items-center justify-center gap-2 transition-all">
                        <i data-lucide="upload-cloud" class="w-5 h-5"></i> Deploy to GitHub Pages
                    </button>
                </div>
            </div>

            <!-- STEP 3: DEPLOYMENT LOGS -->
            <div id="step-3" class="hidden space-y-6">
                <div id="log-container" class="log-window bg-black rounded-lg border border-slate-800 p-4 font-mono text-sm h-80 overflow-y-auto flex flex-col gap-2 shadow-inner">
                    <!-- Logs injected here -->
                </div>

                <div id="success-panel" class="hidden bg-green-900/20 border border-green-800 p-6 rounded-xl flex flex-col items-center text-center space-y-4 animate-bounce-in">
                    <div class="p-4 bg-green-500 rounded-full shadow-lg shadow-green-500/30">
                        <i data-lucide="check-circle" class="text-white w-8 h-8"></i>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-white mb-2">Deployment Sequence Started!</h2>
                        <p class="text-slate-400 max-w-md mx-auto mb-2">
                            Code pushed. GitHub Actions is now building your site.
                        </p>
                    </div>

                    <div class="bg-slate-900/50 rounded-lg p-3 w-full max-w-xs border border-slate-700/50 mb-2">
                        <p class="text-[10px] text-slate-400 mb-1 uppercase tracking-wide">Estimated Build Time</p>
                        <div class="flex items-center justify-center gap-2 text-blue-300 font-mono text-xl font-bold">
                            <i data-lucide="timer" class="w-5 h-5 animate-pulse"></i>
                            <span id="timer-display">00:00</span>
                        </div>
                    </div>
                    
                    <div class="flex flex-col w-full gap-3 mt-2">
                        <a id="btn-visit-site" href="#" target="_blank"
                            class="w-full bg-white text-green-900 hover:bg-slate-100 py-4 rounded-lg font-bold flex items-center justify-center gap-2 transition-all">
                            Visit Live Site <i data-lucide="external-link" class="w-5 h-5"></i>
                        </a>
                        <a id="btn-view-source" href="#" target="_blank"
                            class="w-full bg-slate-800 text-slate-300 hover:bg-slate-700 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-all">
                            View Source Code <i data-lucide="code" class="w-5 h-5"></i>
                        </a>
                        <button onclick="AppController.resetForNew()"
                            class="w-full bg-blue-600 text-white hover:bg-blue-500 py-3 rounded-lg font-medium flex items-center justify-center gap-2 transition-all mt-2">
                            <i data-lucide="refresh-cw" class="w-4 h-4"></i> Deploy Another App
                        </button>
                    </div>
                </div>

                <div id="deploy-error" class="hidden p-4 bg-red-900/20 border border-red-800 rounded-lg flex flex-col gap-2 text-center items-center">
                    <i data-lucide="alert-circle" class="text-red-500 w-8 h-8"></i>
                    <h3 class="text-red-200 font-bold">Deployment Failed</h3>
                    <p id="deploy-error-msg" class="text-red-300/80 text-sm"></p>
                    <button onclick="UI.setStep(2)"
                        class="mt-2 px-4 py-2 bg-red-900/50 hover:bg-red-900 text-red-100 rounded border border-red-700">
                        Try Again
                    </button>
                </div>
            </div>

        </div>
    </div>

    <!-- REPO SELECTION MODAL -->
    <div id="repo-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 w-full max-w-lg rounded-xl shadow-2xl border border-slate-700 flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/50 rounded-t-xl">
                <h3 class="font-bold text-white flex items-center gap-2">Select Repository</h3>
                <button onclick="AppController.closeRepoModal()" class="text-slate-400 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="repo-list-container" class="flex-1 overflow-y-auto p-2 space-y-1"></div>
        </div>
    </div>

    <!-- REPO CREATION CONFIRMATION MODAL -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-slate-800 w-full max-w-sm rounded-xl shadow-2xl border border-slate-700 p-6 text-center">
            <h3 class="text-lg font-bold text-white mb-2">Repository Not Found</h3>
            <p class="text-slate-400 mb-6 text-sm">
                The repository "<span id="confirm-repo-name" class="text-white font-mono font-bold"></span>" does not exist. 
                <br>Would you like to create it?
            </p>
            <div class="flex gap-3">
                <button id="btn-cancel-create" class="flex-1 px-4 py-2 rounded-lg font-medium text-slate-300 hover:bg-slate-700 transition-colors border border-slate-600">Cancel</button>
                <button id="btn-confirm-create" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white rounded-lg px-4 py-2 font-bold transition-all shadow-lg shadow-blue-900/20">Create Repo</button>
            </div>
        </div>
    </div>

    <script>
        const AppState = { step: 1, token: '', username: '', userAvatar: '', repoName: '', mode: 'html', countdownInterval: null };

        // --- Scaffolding Templates ---
        const Scaffolding = {
            mainJsx: `import React from 'react';\nimport ReactDOM from 'react-dom/client';\nimport App from './App.jsx';\nimport './index.css';\n\nReactDOM.createRoot(document.getElementById('root')).render(\n  <React.StrictMode>\n    <App />\n  </React.StrictMode>,\n);`,
            
            indexHtml: `<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n    <title>React App</title>\n  </head>\n  <body>\n    <div id="root"></div>\n    <script type="module" src="/src/main.jsx"><\/script>\n  </body>\n</html>`,
            
            indexCss: `@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\nbody { margin: 0; font-family: sans-serif; }`,
            
            getViteConfig: (repoName) => {
                const isUserSite = repoName.toLowerCase().endsWith('.github.io');
                const base = isUserSite ? '/' : `/${repoName}/`;
                return `import { defineConfig } from 'vite';\nimport react from '@vitejs/plugin-react';\n\nexport default defineConfig({\n  plugins: [react()],\n  base: '${base}',\n});`;
            },

            // UPDATED WORKFLOW: Removes cache: 'npm' and uses npm install instead of npm ci
            getWorkflow: (branch = 'main') => `name: Deploy to GitHub Pages

on:
  push:
    branches: ["${branch}"]

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # cache: 'npm' removed to fix lock file error
          
      - name: Install dependencies
        run: npm install
        
      - name: Build
        run: npm run build
        
      - name: Deploy to gh-pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dist
          branch: gh-pages`
        };

        const Utils = {
            utf8ToBase64: (str) => btoa(unescape(encodeURIComponent(str))),
            delay: (ms) => new Promise(resolve => setTimeout(resolve, ms))
        };

        const GitHubAPI = {
            baseUrl: 'https://api.github.com',
            async request(endpoint, method = 'GET', token, body = null) {
                const headers = { 'Authorization': `token ${token}`, 'Accept': 'application/vnd.github.v3+json', 'Content-Type': 'application/json' };
                const config = { method, headers, body: body ? JSON.stringify(body) : null };
                const response = await fetch(`${this.baseUrl}${endpoint}`, config);
                let data; try { data = await response.json(); } catch(e){ data = null; }
                if (!response.ok) throw new Error(data?.message || `GitHub API Error: ${response.status}`);
                return { data, headers: response.headers };
            },
            async getUser(token) { const res = await this.request('/user','GET',token); return { ...res.data, tokenExpiry: res.headers.get('github-authentication-token-expiration') }; },
            
            // FIX: Handle 404 cleanly so the "if (!repo)" logic can trigger the creation prompt
            async getRepo(token, owner, repo) { 
                try { 
                    const res = await this.request(`/repos/${owner}/${repo}`,'GET',token); 
                    return res.data; 
                } catch(e) { 
                    if(e.message === 'Not Found' || e.message.includes('404')) return null; 
                    throw e; 
                } 
            },
            
            async listRepos(token) { const res = await this.request('/user/repos?sort=updated&per_page=100&type=owner','GET',token); return res.data; },
            async createRepo(token, name, desc) { const res = await this.request('/user/repos','POST',token, { name, description: desc, private: false, auto_init: true }); return res.data; },
            async getRef(token, owner, repo, ref) { try { const res = await this.request(`/repos/${owner}/${repo}/git/ref/${ref}`,'GET',token); return res.data; } catch(e){ return null; } },
            async createRef(token, owner, repo, ref, sha) { return this.request(`/repos/${owner}/${repo}/git/refs`, 'POST', token, { ref: `refs/heads/${ref}`, sha }); },
            async createFile(token, owner, repo, path, content, message, branch='main') {
                let sha = null;
                try { 
                    const res = await this.request(`/repos/${owner}/${repo}/contents/${path}?ref=${branch}`,'GET',token); 
                    sha = res.data.sha; 
                } catch(e) {}
                const body = { message, content: Utils.utf8ToBase64(content), branch };
                if (sha) body.sha = sha;
                return this.request(`/repos/${owner}/${repo}/contents/${path}`, 'PUT', token, body);
            },
            async enablePages(token, owner, repo, branch = 'main') {
                try { await this.request(`/repos/${owner}/${repo}/pages`, 'GET', token); return; } catch(e){}
                return this.request(`/repos/${owner}/${repo}/pages`, 'POST', token, { source: { branch, path: '/' } });
            }
        };

        const UI = {
            setStep(step) {
                AppState.step = step;
                [1,2,3].forEach(s => document.getElementById(`step-${s}`).classList.add('hidden'));
                document.getElementById(`step-${step}`).classList.remove('hidden');
                this.renderStepIndicator();
            },
            toggleMode(mode) {
                AppState.mode = mode;
                const htmlBtn = document.getElementById('mode-html');
                const reactBtn = document.getElementById('mode-react');
                const filenameContainer = document.getElementById('filename-container');
                const reactInfo = document.getElementById('react-info-container');
                const packageJsonContainer = document.getElementById('package-json-container');
                const labelMain = document.getElementById('label-code-main');
                const codeInput = document.getElementById('input-code');

                if (mode === 'react') {
                    htmlBtn.className = "px-6 py-2 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-all";
                    reactBtn.className = "px-6 py-2 rounded-md text-sm font-bold transition-all bg-blue-600 text-white shadow-lg";
                    
                    filenameContainer.classList.add('hidden');
                    reactInfo.classList.remove('hidden');
                    packageJsonContainer.classList.remove('hidden');
                    labelMain.innerHTML = '<span>App.jsx</span><span class="text-xs bg-slate-700 px-2 py-0.5 rounded text-slate-300">Main Component</span>';
                    
                    if (codeInput.value.includes('<!DOCTYPE html>')) {
                        codeInput.value = `import React, { useState } from 'react';\nimport { Folder } from 'lucide-react';\n\nexport default function App() {\n  const [count, setCount] = useState(0);\n  return (\n    <div className="min-h-screen bg-slate-900 text-white flex flex-col items-center justify-center">\n      <h1 className="text-4xl font-bold mb-4 flex items-center gap-2">\n        <Folder /> React on GitHub Pages\n      </h1>\n      <button onClick={() => setCount(c => c + 1)} className="bg-blue-600 px-4 py-2 rounded">\n        Count is {count}\n      </button>\n    </div>\n  );\n}`;
                    }
                } else {
                    htmlBtn.className = "px-6 py-2 rounded-md text-sm font-bold transition-all bg-blue-600 text-white shadow-lg";
                    reactBtn.className = "px-6 py-2 rounded-md text-sm font-medium text-slate-400 hover:text-white transition-all";
                    
                    filenameContainer.classList.remove('hidden');
                    reactInfo.classList.add('hidden');
                    packageJsonContainer.classList.add('hidden');
                    labelMain.innerHTML = '<span>HTML Code</span><span class="text-xs bg-slate-700 px-2 py-0.5 rounded text-slate-300">Paste Here</span>';
                }
            },
            renderStepIndicator() {
                const steps = [1, 2, 3];
                document.getElementById('step-indicator').innerHTML = steps.map(s => `
                    <div class="flex items-center ${s < 3 ? 'flex-1' : ''}">
                        <div class="w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm transition-all
                            ${AppState.step === s ? 'bg-blue-600 text-white shadow-lg scale-110' : 
                              AppState.step > s ? 'bg-green-500 text-white' : 'bg-slate-700 text-slate-400'}">
                            ${AppState.step > s ? '<i data-lucide="check" class="w-4 h-4"></i>' : s}
                        </div>
                        ${s < 3 ? `<div class="h-1 w-full mx-2 rounded ${AppState.step > s ? 'bg-green-500' : 'bg-slate-700'}"></div>` : ''}
                    </div>`).join('');
                lucide.createIcons();
            },
            addLog(msg, type = 'info') {
                const container = document.getElementById('log-container');
                const colors = { error: 'text-red-400', success: 'text-green-400', warning: 'text-yellow-400', info: 'text-blue-300' };
                const div = document.createElement('div');
                div.className = `flex gap-3 ${colors[type]}`;
                div.innerHTML = `<span class="opacity-50 font-mono">[${new Date().toLocaleTimeString()}]</span> <span>${type === 'info' ? '> ' : ''}${msg}</span>`;
                container.appendChild(div);
                container.scrollTop = container.scrollHeight;
            },
            startCountdown(duration) {
                let timer = duration;
                const display = document.getElementById('timer-display');
                if (AppState.countdownInterval) clearInterval(AppState.countdownInterval);
                const update = () => {
                    let m = parseInt(timer / 60, 10).toString().padStart(2, '0');
                    let s = parseInt(timer % 60, 10).toString().padStart(2, '0');
                    display.textContent = `${m}:${s}`;
                };
                update();
                AppState.countdownInterval = setInterval(() => {
                    timer--;
                    if (timer < 0) { clearInterval(AppState.countdownInterval); display.textContent = "Ready?"; return; }
                    update();
                }, 1000);
            },
            askToCreateRepo(repoName) {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirm-modal');
                    const nameSpan = document.getElementById('confirm-repo-name');
                    const btnConfirm = document.getElementById('btn-confirm-create');
                    const btnCancel = document.getElementById('btn-cancel-create');

                    nameSpan.textContent = repoName;
                    modal.classList.remove('hidden');

                    const newConfirm = btnConfirm.cloneNode(true);
                    const newCancel = btnCancel.cloneNode(true);
                    btnConfirm.parentNode.replaceChild(newConfirm, btnConfirm);
                    btnCancel.parentNode.replaceChild(newCancel, btnCancel);

                    newConfirm.addEventListener('click', () => { modal.classList.add('hidden'); resolve(true); });
                    newCancel.addEventListener('click', () => { modal.classList.add('hidden'); resolve(false); });
                });
            }
        };

        const AppController = {
            async init() {
                const savedToken = localStorage.getItem('gh_token');
                if (savedToken) { document.getElementById('input-token').value = savedToken; await AppController.verifyToken(); }
                lucide.createIcons();
                UI.renderStepIndicator();
            },
            goHome() {
                if (AppState.token) {
                    document.getElementById('log-container').innerHTML = '';
                    document.getElementById('success-panel').classList.add('hidden');
                    document.getElementById('deploy-error').classList.add('hidden');
                    if (AppState.countdownInterval) clearInterval(AppState.countdownInterval);
                    UI.setStep(2);
                } else {
                    UI.setStep(1);
                }
            },
            async verifyToken() {
                const token = document.getElementById('input-token').value.trim();
                if (!token) return;
                try {
                    const user = await GitHubAPI.getUser(token);
                    AppState.token = token; AppState.username = user.login; AppState.userAvatar = user.avatar_url;
                    localStorage.setItem('gh_token', token);
                    document.getElementById('user-profile').classList.remove('hidden');
                    document.getElementById('user-avatar').src = AppState.userAvatar;
                    document.getElementById('user-login').textContent = AppState.username;
                    document.getElementById('username-hint').textContent = AppState.username;
                    UI.setStep(2);
                } catch(e) { document.getElementById('error-message').classList.remove('hidden'); document.getElementById('error-text').textContent = e.message; }
            },
            async deploy() {
                const repoInput = document.getElementById('input-repo-name');
                const codeInput = document.getElementById('input-code');
                const packageInput = document.getElementById('input-package-json');
                
                AppState.repoName = repoInput.value.trim().replace(/ /g, '-');
                const mainCode = codeInput.value;
                const packageJson = packageInput.value;

                UI.setStep(3);
                document.getElementById('log-container').innerHTML = '';
                document.getElementById('success-panel').classList.add('hidden');
                document.getElementById('deploy-error').classList.add('hidden');

                try {
                    UI.addLog(`Starting ${AppState.mode.toUpperCase()} deployment...`, 'info');

                    // 1. Create or Get Repo
                    UI.addLog(`Checking repository "${AppState.repoName}"...`, 'info');
                    let repo = await GitHubAPI.getRepo(AppState.token, AppState.username, AppState.repoName);
                    
                    if (!repo) {
                        UI.addLog(`Repository "${AppState.repoName}" not found.`, 'warning');
                        const shouldCreate = await UI.askToCreateRepo(AppState.repoName);
                        if (!shouldCreate) {
                            UI.addLog('Repository creation cancelled by user.', 'error');
                            throw new Error('Deployment cancelled.');
                        }
                        UI.addLog(`Creating repository "${AppState.repoName}"...`, 'info');
                        repo = await GitHubAPI.createRepo(AppState.token, AppState.repoName, 'Deployed via GitDeploy Bridge');
                        UI.addLog('Repository created.', 'success');
                        await Utils.delay(2000); 
                    } else {
                        UI.addLog('Repository exists.', 'success');
                    }

                    // 2. Deployment Logic
                    if (AppState.mode === 'html') {
                        const fileName = document.getElementById('input-filename').value.trim();
                        UI.addLog(`Committing ${fileName}...`, 'info');
                        await GitHubAPI.createFile(AppState.token, AppState.username, AppState.repoName, fileName, mainCode, 'Deploy HTML');
                        UI.addLog('File pushed.', 'success');
                        
                        UI.addLog('Enabling GitHub Pages...', 'info');
                        await GitHubAPI.enablePages(AppState.token, AppState.username, AppState.repoName);
                        
                        UI.startCountdown(120);
                    } else {
                        // REACT MODE
                        // Ensure gh-pages branch exists by creating it from main if possible
                        // This allows enablePages to work immediately, even before the Action populates it
                        const mainRef = await GitHubAPI.getRef(AppState.token, AppState.username, AppState.repoName, 'heads/main');
                        if (mainRef) {
                            try {
                                await GitHubAPI.createRef(AppState.token, AppState.username, AppState.repoName, 'gh-pages', mainRef.object.sha);
                                UI.addLog('Pre-created gh-pages branch (will be overwritten by build).', 'info');
                            } catch(e) { /* Branch likely exists */ }
                        }
                        
                        UI.addLog('Scaffolding React project structure...', 'info');
                        const files = [
                            { path: 'package.json', content: packageJson },
                            { path: 'vite.config.js', content: Scaffolding.getViteConfig(AppState.repoName) },
                            { path: 'index.html', content: Scaffolding.indexHtml },
                            { path: 'src/main.jsx', content: Scaffolding.mainJsx },
                            { path: 'src/App.jsx', content: mainCode },
                            { path: 'src/index.css', content: Scaffolding.indexCss },
                            { path: '.github/workflows/deploy.yml', content: Scaffolding.getWorkflow() }
                        ];

                        for (const file of files) {
                            UI.addLog(`Pushing ${file.path}...`, 'info');
                            await GitHubAPI.createFile(AppState.token, AppState.username, AppState.repoName, file.path, file.content, 'Scaffold React App');
                        }
                        
                        UI.addLog('Configuring Pages source to gh-pages branch...', 'info');
                        try {
                            await GitHubAPI.enablePages(AppState.token, AppState.username, AppState.repoName, 'gh-pages');
                        } catch(e) { UI.addLog('Note: Pages config might wait for first build.', 'warning'); }

                        UI.startCountdown(180);
                    }

                    let finalUrl = AppState.repoName.toLowerCase() === `${AppState.username.toLowerCase()}.github.io` 
                        ? `https://${AppState.username}.github.io/` 
                        : `https://${AppState.username}.github.io/${AppState.repoName}/`;
                    
                    document.getElementById('btn-visit-site').href = finalUrl;
                    document.getElementById('btn-view-source').href = `https://github.com/${AppState.username}/${AppState.repoName}`;
                    document.getElementById('success-panel').classList.remove('hidden');
                    UI.addLog('Done! GitHub Actions should be running now.', 'success');

                } catch(e) {
                    UI.addLog(`Error: ${e.message}`, 'error');
                    document.getElementById('deploy-error-msg').textContent = e.message;
                    document.getElementById('deploy-error').classList.remove('hidden');
                }
            },
            logout() { localStorage.removeItem('gh_token'); location.reload(); },
            resetForNew() { UI.setStep(2); document.getElementById('success-panel').classList.add('hidden'); },
            openRepoModal() { 
                document.getElementById('repo-modal').classList.remove('hidden');
                const list = document.getElementById('repo-list-container');
                list.innerHTML = '<div class="p-4 text-center">Loading...</div>';
                GitHubAPI.listRepos(AppState.token).then(repos => {
                    list.innerHTML = repos.map(r => `
                        <div onclick="document.getElementById('input-repo-name').value='${r.name}';document.getElementById('repo-modal').classList.add('hidden');" 
                             class="p-3 border-b border-slate-700 hover:bg-slate-700 cursor-pointer flex justify-between">
                            <span>${r.name}</span> <span class="text-xs bg-slate-700 px-2 rounded">${r.private?'Private':'Public'}</span>
                        </div>`).join('');
                });
            },
            closeRepoModal() { document.getElementById('repo-modal').classList.add('hidden'); }
        };

        window.onload = AppController.init;
    </script>
</body>
</html>